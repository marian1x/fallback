{% extends "base.html" %}
{% block title %}Investor Payout Report{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2><i class="fas fa-chart-pie me-2"></i>Investor Payout Report</h2>
        <button id="refreshBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-sync-alt me-1"></i> Refresh</button>
    </div>
    <p>This report shows the real-time profit/loss distribution based on each user's investment share.</p>

    <div class="row">
        <div class="col-md-4">
            <div class="card text-white bg-secondary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Investment</h5>
                    <p id="summary-total-investment" class="card-text fs-4 fw-bold">$0.00</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title">Live Account Equity</h5>
                    <p id="summary-live-equity" class="card-text fs-4 fw-bold">$0.00</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-dark mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Profit / Loss</h5>
                    <p id="summary-total-pl" class="card-text fs-4 fw-bold">$0.00</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card data-card">
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Contribution</th>
                        <th>Ownership</th>
                        <th>P/L Share</th>
                        <th>Current Equity</th>
                    </tr>
                </thead>
                <tbody id="payout-table-body">
                    <tr><td colspan="5" class="text-center">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    }

    async function fetchPayoutData() {
        const tableBody = document.getElementById('payout-table-body');
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Loading data...</td></tr>';
        
        try {
            const response = await fetch('/api/investor_payout_data');
            const data = await response.json();
            
            if (!response.ok) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${data.error}</td></tr>`;
                return;
            }

            document.getElementById('summary-total-investment').textContent = formatCurrency(data.total_investment);
            document.getElementById('summary-live-equity').textContent = formatCurrency(data.live_equity);
            
            const plElement = document.getElementById('summary-total-pl');
            plElement.textContent = formatCurrency(data.total_pl);
            const plCard = plElement.closest('.card');
            plCard.classList.remove('bg-dark', 'bg-success', 'bg-danger');
            plCard.classList.add(data.total_pl >= 0 ? 'bg-success' : 'bg-danger');

            tableBody.innerHTML = '';
            if (data.investors.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No investors configured. Please ask the admin to set investment amounts.</td></tr>';
            } else {
                data.investors.forEach(inv => {
                    const plShareClass = inv.pl_share >= 0 ? 'text-success' : 'text-danger';
                    const isCurrentUser = inv.username === "{{ g.user.username }}";
                    const row = `
                        <tr class="${isCurrentUser ? 'table-info' : ''}">
                            <td><strong>${inv.username}</strong> ${isCurrentUser ? '<span class="badge bg-primary">You</span>' : ''}</td>
                            <td>${formatCurrency(inv.investment)}</td>
                            <td>${inv.ownership_percent.toFixed(2)}%</td>
                            <td class="${plShareClass}">${formatCurrency(inv.pl_share)}</td>
                            <td><strong>${formatCurrency(inv.current_equity)}</strong></td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }
        } catch (error) {
            console.error('Failed to fetch payout data:', error);
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Failed to load data.</td></tr>`;
        }
    }

    document.getElementById('refreshBtn').addEventListener('click', fetchPayoutData);
    document.addEventListener('DOMContentLoaded', fetchPayoutData);
</script>
{% endblock %}