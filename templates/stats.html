{% extends "base.html" %}
{% block title %}Advanced Analytics - TradingBot{% endblock %}
{% block content %}
<div class="container-fluid my-4 animate__animated animate__fadeIn">
  <h3 class="mb-3">Advanced Analytics</h3>
  <div class="row mb-3">
    <div class="col-12 col-md-8">
      <label>Filter by Close Date:</label>
      <input type="date" id="aDateFrom" class="form-control form-control-sm d-inline" style="width:auto;">
      <input type="date" id="aDateTo" class="form-control form-control-sm d-inline" style="width:auto;">
      <button class="btn btn-sm btn-outline-primary" id="aClearDate">Clear</button>
    </div>
  </div>
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header"><i class="fa-solid fa-gauge-high me-2"></i>Core Performance</div>
        <div class="card-body">
            <div class="d-flex justify-content-between border-bottom pb-2 mb-2"><span>Total Net P&L</span><strong id="aTotalPL">$0.00</strong></div>
            <div class="d-flex justify-content-between border-bottom pb-2 mb-2"><span>Total Trades</span><strong id="aTotalTrades">0</strong></div>
            <div class="d-flex justify-content-between border-bottom pb-2 mb-2"><span>Win Rate</span><strong id="aWinRate">0%</strong></div>
            <div class="d-flex justify-content-between border-bottom pb-2 mb-2"><span>Profit Factor</span><strong id="aProfitFactor">0.00</strong></div>
            <div class="d-flex justify-content-between border-bottom pb-2 mb-2"><span>Avg. Trade P&L</span><strong id="aAvgRet">$0.00</strong></div>
            <div class="d-flex justify-content-between pb-2 mb-2"><span>Max Drawdown</span><strong id="aMaxDD">$0.00</strong></div>
            <hr>
            <div class="row">
                <div class="col-6">
                    <div class="text-center">
                        <div class="small text-muted">Wins / Losses</div>
                        <strong><span id="aWins">0</span> / <span id="aLosses">0</span></strong>
                    </div>
                </div>
                 <div class="col-6">
                    <div class="text-center">
                        <div class="small text-muted">Avg Win / Loss</div>
                        <strong><span id="aAvgWin">$0</span> / <span id="aAvgLoss">$0</span></strong>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </div>
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header"><i class="fa-solid fa-chart-line me-2"></i>Cumulative P&L Over Time</div>
        <div class="card-body">
          <canvas id="aPLTimeChart" height="110"></canvas>
        </div>
      </div>
       <div class="row g-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header"><i class="fa-solid fa-chart-pie me-2"></i>Long vs. Short P&L</div>
                    <div class="card-body">
                        <canvas id="aLongShortChart" height="150"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                 <div class="card shadow-sm">
                    <div class="card-header"><i class="fa-solid fa-calendar-days me-2"></i>Monthly P&L</div>
                    <div class="card-body">
                        <canvas id="aMonthlyPLChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script>
let allTrades = [];
let aDateFrom = "", aDateTo = "";
let charts = {};

// Utility to destroy old charts before creating new ones
function destroyChart(chartId) {
    if (charts[chartId]) {
        charts[chartId].destroy();
    }
}

function computeAnalytics() {
    // Filter trades by date range
    let filteredTrades = allTrades.filter(t => {
        if (!t.close_time) return false;
        const closeDate = t.close_time.slice(0, 10);
        const fromOk = !aDateFrom || closeDate >= aDateFrom;
        const toOk = !aDateTo || closeDate <= aDateTo;
        return fromOk && toOk;
    }).sort((a, b) => new Date(a.close_time) - new Date(b.close_time));

    // --- Core Stats Calculations ---
    let totalPL = 0, grossProfit = 0, grossLoss = 0;
    let wins = 0, losses = 0, tradeCount = filteredTrades.length;
    let longPL = 0, shortPL = 0;
    let equityCurve = [0];
    let monthlyPL = {};

    filteredTrades.forEach(t => {
        const pl = t.profit_loss || 0;
        totalPL += pl;
        equityCurve.push(totalPL);
        
        if (pl > 0) {
            wins++;
            grossProfit += pl;
        } else if (pl < 0) {
            losses++;
            grossLoss += Math.abs(pl);
        }

        if (t.side.toLowerCase() === 'buy') {
            longPL += pl;
        } else {
            shortPL += pl;
        }

        const month = luxon.DateTime.fromISO(t.close_time).toFormat('yyyy-MM');
        monthlyPL[month] = (monthlyPL[month] || 0) + pl;
    });

    // Max Drawdown
    let peak = 0, maxDD = 0;
    equityCurve.forEach(equity => {
        if (equity > peak) peak = equity;
        const drawdown = peak - equity;
        if (drawdown > maxDD) maxDD = drawdown;
    });

    const winRate = tradeCount > 0 ? (100 * wins / tradeCount) : 0;
    const profitFactor = grossLoss > 0 ? (grossProfit / grossLoss) : 0;
    const avgReturn = tradeCount > 0 ? (totalPL / tradeCount) : 0;
    const avgWin = wins > 0 ? (grossProfit / wins) : 0;
    const avgLoss = losses > 0 ? (grossLoss / losses) : 0;

    // --- Update DOM ---
    $("#aTotalPL").text(`$${totalPL.toFixed(2)}`).toggleClass('profit', totalPL > 0).toggleClass('loss', totalPL < 0);
    $("#aTotalTrades").text(tradeCount);
    $("#aWinRate").text(`${winRate.toFixed(1)}%`);
    $("#aProfitFactor").text(profitFactor.toFixed(2));
    $("#aAvgRet").text(`$${avgReturn.toFixed(2)}`);
    $("#aMaxDD").text(`$${maxDD.toFixed(2)}`);
    $("#aWins").text(wins);
    $("#aLosses").text(losses);
    $("#aAvgWin").text(`$${avgWin.toFixed(2)}`).addClass('profit');
    $("#aAvgLoss").text(`$${avgLoss.toFixed(2)}`).addClass('loss');

    // --- Render Charts ---
    // P&L Over Time Chart
    destroyChart('aPLTimeChart');
    charts['aPLTimeChart'] = new Chart(document.getElementById('aPLTimeChart'), {
        type: 'line',
        data: {
            labels: Array.from({length: equityCurve.length}, (_, i) => i),
            datasets: [{
                label: "Cumulative P&L",
                data: equityCurve,
                borderColor: 'rgba(100, 255, 218, 0.8)',
                backgroundColor: 'rgba(100, 255, 218, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: { plugins: { legend: { display: false } }, scales: { x: { display: false } } }
    });

    // Long vs. Short Chart
    destroyChart('aLongShortChart');
    charts['aLongShortChart'] = new Chart(document.getElementById('aLongShortChart'), {
        type: 'doughnut',
        data: {
            labels: ['Long Trades', 'Short Trades'],
            datasets: [{
                data: [longPL, shortPL],
                backgroundColor: ['#28a745', '#dc3545']
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } } }
    });

    // Monthly P&L Chart
    destroyChart('aMonthlyPLChart');
    const sortedMonths = Object.keys(monthlyPL).sort();
    charts['aMonthlyPLChart'] = new Chart(document.getElementById('aMonthlyPLChart'), {
        type: 'bar',
        data: {
            labels: sortedMonths,
            datasets: [{
                label: 'Monthly P&L',
                data: sortedMonths.map(m => monthlyPL[m]),
                backgroundColor: sortedMonths.map(m => monthlyPL[m] > 0 ? '#64ffda' : '#ff8b8b')
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });
}

function fetchAnalyticsData(){
    $.get('/api/closed_orders', function(data){
        allTrades = data;
        computeAnalytics();
    });
}

$(document).ready(function(){
    fetchAnalyticsData();
    $('#aDateFrom, #aDateTo').on('change', function(){
        aDateFrom = $('#aDateFrom').val();
        aDateTo = $('#aDateTo').val();
        computeAnalytics();
    });
    $('#aClearDate').on('click', function(){
        $('#aDateFrom, #aDateTo').val('');
        aDateFrom = aDateTo = "";
        computeAnalytics();
    });
});
</script>
{% endblock %}