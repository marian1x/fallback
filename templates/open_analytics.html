{% extends "base.html" %}
{% block title %}Open Trades Analytics - TradingBot{% endblock %}
{% block content %}
<div class="container-fluid my-4 animate__animated animate__fadeIn">
  <h3 class="mb-3">Open Trades Analytics</h3>
  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <i class="fa-solid fa-fire-flame-curved me-2"></i> Open Positions Heatmap (by Market Value)
        </div>
        <div class="card-body">
          <canvas id="openHeatmapChart" height="120"></canvas>
        </div>
      </div>
       <div class="card shadow-sm">
        <div class="card-header">
          <i class="fa-solid fa-hourglass-half me-2"></i> Open Trade Durations (Hours)
        </div>
        <div class="card-body">
          <canvas id="openDurationsChart" height="120"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header">
          <i class="fa-solid fa-table-list me-2"></i> Open Trades Snapshot
        </div>
        <div class="card-body p-0">
          <table id="openTradesTable" class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Side</th>
                <th>Live P/L</th>
                <th>Since Open</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script>
let openAnalyticsCharts = {};

function destroyChart(chartId) {
    if (openAnalyticsCharts[chartId]) {
        openAnalyticsCharts[chartId].destroy();
    }
}

function fetchOpenAnalytics() {
    $.get('/api/open_positions', function(data){
        // --- Table ---
        let table = $('#openTradesTable').DataTable();
        table.clear();
        data.sort((a,b) => b.market_value - a.market_value); // Sort by largest position

        data.forEach(r => {
            let durationStr = "-";
            if (r.open_time_iso) {
                const openTime = luxon.DateTime.fromISO(r.open_time_iso);
                const duration = luxon.DateTime.now().diff(openTime, ['days', 'hours', 'minutes']);
                if (duration.days > 0) {
                    durationStr = `${duration.days}d ${Math.round(duration.hours)}h`;
                } else {
                    durationStr = `${Math.round(duration.hours)}h ${Math.round(duration.minutes)}m`;
                }
            }
            table.row.add([
                r.symbol.replace('USD', '/USD'),
                r.side.toUpperCase(),
                `<span class="${r.unrealized_pl > 0 ? 'profit' : 'loss'}">${r.unrealized_pl.toFixed(2)}</span>`,
                durationStr
            ]);
        });
        table.draw();

        // --- Charts ---
        const labels = data.map(p => p.symbol.replace('USD', '/USD'));
        const marketValues = data.map(p => p.market_value);
        const pnlValues = data.map(p => p.unrealized_pl);
        const durations = data.map(p => {
            if (!p.open_time_iso) return 0;
            const openTime = luxon.DateTime.fromISO(p.open_time_iso);
            return luxon.DateTime.now().diff(openTime, 'hours').hours;
        });

        // Heatmap Chart
        destroyChart('openHeatmapChart');
        openAnalyticsCharts['openHeatmapChart'] = new Chart(document.getElementById('openHeatmapChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Market Value ($)',
                    data: marketValues,
                    backgroundColor: pnlValues.map(pl => pl >= 0 ? 'rgba(100, 255, 218, 0.6)' : 'rgba(255, 139, 139, 0.6)'),
                    borderColor: pnlValues.map(pl => pl >= 0 ? '#64ffda' : '#ff8b8b'),
                    borderWidth: 1
                }]
            },
            options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
        });

        // Durations Chart
        destroyChart('openDurationsChart');
        openAnalyticsCharts['openDurationsChart'] = new Chart(document.getElementById('openDurationsChart'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Duration (hours)',
                    data: durations,
                    backgroundColor: 'rgba(88, 166, 255, 0.6)',
                    borderColor: '#58a6ff',
                    borderWidth: 1
                }]
            },
            options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
        });
    });
}

$(document).ready(function(){
    $('#openTradesTable').DataTable({paging: false, searching: false, info: false, order: []});
    fetchOpenAnalytics();
    setInterval(fetchOpenAnalytics, 15000); // Refresh every 15 seconds
});
</script>
{% endblock %}