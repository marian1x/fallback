{% extends "base.html" %}
{% block title %}User Management - Admin{% endblock %}
{% block content %}
<div class="container-fluid my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>User Management</h3>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal"><i class="fa fa-plus me-2"></i>Create User</button>
    </div>
    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>TV User</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.username }} {% if user.is_superuser %}<span class="badge bg-info">Superuser</span>{% endif %}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.tradingview_user }}</td>
                        <td>
                            {% if user.is_trading_restricted %}
                                <span class="badge bg-danger">Trading Restricted</span>
                            {% else %}
                                <span class="badge bg-success">Active</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editUserModal-{{ user.id }}">Edit</button>
                                <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#resetPasswordModal-{{ user.id }}">Password</button>
                                {% if not user.is_superuser %}
                                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteUserModal-{{ user.id }}">Delete</button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% for user in users %}
<div class="modal fade" id="editUserModal-{{ user.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('admin_update_user', user_id=user.id) }}" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Edit User: {{ user.username }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" name="username" class="form-control" value="{{ user.username }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">TradingView User</label>
            <input type="text" name="tradingview_user" class="form-control" value="{{ user.tradingview_user }}" required>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="is_trading_restricted" id="restrict-{{ user.id }}" {% if user.is_trading_restricted %}checked{% endif %}>
            <label class="form-check-label" for="restrict-{{ user.id }}">Restrict Trading</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="resetPasswordModal-{{ user.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('admin_reset_password', user_id=user.id) }}" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Reset Password for {{ user.username }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Enter a new password for the user.</p>
          <input type="password" name="new_password" class="form-control" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-warning">Reset Password</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteUserModal-{{ user.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('admin_delete_user', user_id=user.id) }}" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Delete User {{ user.username }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-danger">Are you sure? This will delete the user and all their associated trades. This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Yes, Delete User</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<div class="modal fade" id="createUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('admin_create_user') }}" method="post">
        <div class="modal-header">
          <h5 class="modal-title">Create New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2"><label>Username</label><input type="text" name="username" class="form-control" required></div>
          <div class="mb-2"><label>Email</label><input type="email" name="email" class="form-control" required></div>
          <div class="mb-2"><label>TradingView User</label><input type="text" name="tradingview_user" class="form-control" required></div>
          <div class="mb-2"><label>Password</label><input type="password" name="password" class="form-control" required></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Create User</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}