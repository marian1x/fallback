{% extends "base.html" %}

{% block title %}Admin - All Open Trades{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Admin - All Open Positions</h2>

    <div class="row mb-3 align-items-end">
        <div class="col-md-4">
            <label for="userFilter" class="form-label">Filter by User</label>
            <select id="userFilter" class="form-select">
                <option value="">All Users</option>
                {% for user in all_users %}
                    {% if not user.is_superuser and user.encrypted_alpaca_key %}
                        <option value="{{ user.id }}">{{ user.username }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="col-md-8">
            <button id="closeSelectedBtn" class="btn btn-danger">Close Selected</button>
        </div>
    </div>

    <table id="adminOpenTradesTable" class="table table-striped" style="width:100%">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAllCheckbox"></th>
                <th>User</th>
                <th>Symbol</th>
                <th>Side</th>
                <th>Qty</th>
                <th>Open Price</th>
                <th>Current Price</th>
                <th>Unrealized P/L</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.querySelector('#adminOpenTradesTable tbody');
    const userFilter = document.getElementById('userFilter');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const closeSelectedBtn = document.getElementById('closeSelectedBtn');
    let dataTable;

    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    }

    function renderTable(data) {
        if (dataTable) {
            dataTable.destroy();
        }
        tableBody.innerHTML = ''; // Clear existing data

        data.forEach(p => {
            const plClass = p.unrealized_pl >= 0 ? 'text-success' : 'text-danger';
            const row = `
                <tr>
                    <td><input type="checkbox" class="trade-checkbox" data-user-id="${p.user_id}" data-symbol="${p.symbol}"></td>
                    <td>${p.username}</td>
                    <td>${p.symbol}</td>
                    <td class="text-capitalize">${p.side}</td>
                    <td>${Math.abs(p.qty)}</td>
                    <td>${formatCurrency(p.open_price)}</td>
                    <td>${formatCurrency(p.current_price)}</td>
                    <td class="${plClass}">${formatCurrency(p.unrealized_pl)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning close-trade-btn" data-user-id="${p.user_id}" data-symbol="${p.symbol}">
                            Close
                        </button>
                    </td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', row);
        });

        dataTable = new DataTable('#adminOpenTradesTable');
    }

    function fetchAndRenderTable(userId = '') {
        let url = '/api/admin/all_open_positions';
        if (userId) {
            url += `?user_id=${userId}`;
        }
        fetch(url)
            .then(response => response.json())
            .then(renderTable)
            .catch(error => {
                console.error('Error fetching open positions:', error);
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center">Failed to load data.</td></tr>';
            });
    }

    userFilter.addEventListener('change', () => {
        fetchAndRenderTable(userFilter.value);
    });

    selectAllCheckbox.addEventListener('change', function() {
        document.querySelectorAll('.trade-checkbox').forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    function closeTrades(tradesToClose) {
        if (tradesToClose.length === 0) {
            alert('No trades selected.');
            return;
        }

        if (!confirm(`Are you sure you want to close ${tradesToClose.length} trade(s)? This action is irreversible.`)) {
            return;
        }

        fetch('/api/admin/close_trades', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trades: tradesToClose })
        })
        .then(response => response.json())
        .then(data => {
            let message = `Successfully closed ${data.closed} trade(s).`;
            if (data.errors && data.errors.length > 0) {
                message += "\n\nErrors:\n" + data.errors.join("\n");
            }
            alert(message);
            fetchAndRenderTable(userFilter.value); // Refresh table
        })
        .catch(error => {
            console.error('Error closing trades:', error);
            alert('A critical error occurred while trying to close trades.');
        });
    }

    closeSelectedBtn.addEventListener('click', () => {
        const selectedTrades = Array.from(document.querySelectorAll('.trade-checkbox:checked'))
            .map(cb => ({ user_id: cb.dataset.userId, symbol: cb.dataset.symbol }));
        closeTrades(selectedTrades);
    });

    tableBody.addEventListener('click', function(event) {
        if (event.target.classList.contains('close-trade-btn')) {
            const trade = {
                user_id: event.target.dataset.userId,
                symbol: event.target.dataset.symbol
            };
            closeTrades([trade]);
        }
    });

    // Initial load
    fetchAndRenderTable();
});
</script>
{% endblock %}