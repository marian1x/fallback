{% extends "base.html" %}
{% block title %}{{ _('Closed Trades') }} - {{ _('TradingBot') }}{% endblock %}
{% block content %}
<div class="container-fluid my-4 animate__animated animate__fadeIn">

    {% if g.user.is_superuser %}
    <div class="card shadow-sm mb-4">
        <div class="card-header"><i class="fa-solid fa-trophy me-2"></i>Performance Leaderboard</div>
        <div class="card-body">
            <table id="leaderboardTable" class="table table-hover" style="width:100%;">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Username</th>
                        <th>Total P/L</th>
                        <th>Win Rate</th>
                        <th>Wins</th>
                        <th>Losses</th>
                        <th>Total Trades</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="row mb-3 align-items-end gy-3">
        <div class="col-md-auto">
            <label class="form-label small">{{ _('Filter by Close Date') }}</label>
            <div>
                <input type="date" id="dateFrom" class="form-control form-control-sm d-inline" style="width:auto;">
                <span>-</span>
                <input type="date" id="dateTo" class="form-control form-control-sm d-inline" style="width:auto;">
            </div>
        </div>
        <div class="col-md-auto">
             <label class="form-label small d-none d-md-block">&nbsp;</label>
            <div>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" data-preset="today">Today</button>
                    <button type="button" class="btn btn-outline-secondary" data-preset="week">This Week</button>
                    <button type="button" class="btn btn-outline-secondary" data-preset="month">This Month</button>
                    <button type="button" class="btn btn-outline-secondary" data-preset="year">This Year</button>
                    <button type="button" class="btn btn-outline-secondary" id="clearDate">{{ _('Clear') }}</button>
                </div>
            </div>
        </div>
        {% if g.user.is_superuser and all_users %}
        <div class="col-md-auto">
            <label for="userFilter" class="form-label small">Filter by User</label>
            <select id="userFilter" class="form-select form-select-sm">
                <option value="0" selected>All Users</option>
                {% for u in all_users %}
                <option value="{{ u.id }}">{{ u.username }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>
    
    <div class="row g-4">
        <div class="col-12 {% if not g.user.is_superuser %}col-lg-8{% endif %}">
            <div class="card shadow-sm">
                <div class="card-header"><i class="fa fa-check-circle me-2"></i>{{ _('Closed Orders') }}</div>
                <div class="card-body">
                    <table id="closedTable" class="table table-hover" style="width:100%;">
                        <thead>
                            <tr>
                                <th>{{ _('Symbol') }}</th>
                                <th>{{ _('Side') }}</th>
                                <th>{{ _('Open Price') }}</th>
                                <th>{{ _('Close Price') }}</th>
                                <th>{{ _('P/L') }}</th>
                                <th>{{ _('P/L %%') }}</th>
                                <th>{{ _('Open Time') }}</th>
                                <th>{{ _('Close Time') }}</th>
                                <th>{{ _('Exit Reason') }}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        {% if not g.user.is_superuser %}
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header"><i class="fa-solid fa-calculator me-2"></i>{{ _('Filtered Stats') }}</div>
                <div class="card-body">
                    <div class="stat-item" id="ctStatPL">{{ _('Total Net P/L') }}: $0</div>
                    <div class="stat-item" id="ctStatWinrate">{{ _('Win Rate') }}: 0%</div>
                    <div class="stat-item" id="ctStatWins">{{ _('Wins') }}: 0</div>
                    <div class="stat-item" id="ctStatLosses">{{ _('Losses') }}: 0</div>
                    <hr class="my-3">
                    <div class="stat-item" id="ctBestTrade">{{ _('Best Trade') }}: <span class="text-muted">N/A</span></div>
                    <div class="stat-item" id="ctWorstTrade">{{ _('Worst Trade') }}: <span class="text-muted">N/A</span></div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script>
    let allClosedOrders = [];
    let closedOrdersTable;
    let leaderboardTable;

    function toLocalTime(isoString) {
        if (!isoString) return "-";
        return luxon.DateTime.fromISO(isoString, { zone: "utc" }).toFormat("dd/MM/yyyy, HH:mm:ss");
    }

    function colorPL(val, withSign = false) {
        if (typeof val !== 'number') return '<span>-</span>';
        const sign = val > 0 ? '+' : '';
        const className = val > 0 ? 'profit' : (val < 0 ? 'loss' : '');
        return `<span class="${className}">${withSign ? sign : ''}${val.toFixed(2)}</span>`;
    }

    function fetchAndRenderTrades() {
        const userId = $('#userFilter').length ? $('#userFilter').val() : '{{ g.user.id }}';
        $.get('/api/closed_orders', { user_id: userId }, function(data) {
            if (!Array.isArray(data)) {
                console.error('Closed orders API returned non-array response:', data);
                allClosedOrders = [];
            } else {
                allClosedOrders = data;
            }
            renderFilteredTrades();
        }).fail(function(xhr) {
            console.error('Failed to fetch closed orders:', xhr.responseText || xhr.statusText);
            allClosedOrders = [];
            renderFilteredTrades();
        });
    }

    function renderFilteredTrades() {
        if (!closedOrdersTable) return;
        const dateFrom = $('#dateFrom').val(), dateTo = $('#dateTo').val();
        const filtered = allClosedOrders.filter(r => {
            const closeTime = r.close_time || r.open_time;
            if (!closeTime) return false;
            const closeDate = closeTime.slice(0, 10);
            return (!dateFrom || closeDate >= dateFrom) && (!dateTo || closeDate <= dateTo);
        });
        
        closedOrdersTable.clear();
        filtered.forEach(r => {
            const openTimeOrder = r.open_time || '';
            const closeTimeOrder = r.close_time || '';
            const openTimeDisplay = toLocalTime(r.open_time);
            const closeTimeDisplay = toLocalTime(r.close_time);
            closedOrdersTable.row.add([
                r.symbol.replace('USD', '/USD'), r.side ? r.side.toUpperCase() : '-',
                r.open_price ? r.open_price.toFixed(4) : '-', r.close_price ? r.close_price.toFixed(4) : '-',
                colorPL(r.profit_loss, true), r.profit_loss_pct ? r.profit_loss_pct.toFixed(2) + '%' : '-',
                `<span data-order="${openTimeOrder}">${openTimeDisplay}</span>`,
                `<span data-order="${closeTimeOrder}">${closeTimeDisplay}</span>`,
                r.action ? `<span class="badge bg-info text-dark">${r.action}</span>` : ''
            ]);
        });
        closedOrdersTable.draw();
        
        if (!$('#leaderboardTable').length) {
            updateStatsPanel(filtered);
        }
    }
    
    function updateStatsPanel(filteredTrades) {
        let totalPL = 0, wins = 0, losses = 0, bestTrade = null, worstTrade = null;
        filteredTrades.forEach(trade => {
            const pl = trade.profit_loss || 0;
            totalPL += pl;
            if (pl > 0) wins++; else if (pl < 0) losses++;
            if (!bestTrade || pl > bestTrade.profit_loss) bestTrade = trade;
            if (!worstTrade || pl < worstTrade.profit_loss) worstTrade = trade;
        });
        const winrate = wins + losses > 0 ? (100 * wins / (wins + losses)).toFixed(1) : "0";
        $("#ctStatPL").html(`{{ _('Total Net P/L') }}: ${colorPL(totalPL)}`);
        $("#ctStatWinrate").text(`{{ _('Win Rate') }}: ${winrate}%`);
        $("#ctStatWins").text(`{{ _('Wins') }}: ${wins}`);
        $("#ctStatLosses").text(`{{ _('Losses') }}: ${losses}`);
        $("#ctBestTrade").html(`{{ _('Best Trade') }}: ${bestTrade ? `${bestTrade.symbol} (${colorPL(bestTrade.profit_loss, true)})` : '<span class="text-muted">N/A</span>'}`);
        $("#ctWorstTrade").html(`{{ _('Worst Trade') }}: ${worstTrade ? `${worstTrade.symbol} (${colorPL(worstTrade.profit_loss, true)})` : '<span class="text-muted">N/A</span>'}`);
    }

    $(document).ready(function() {
        closedOrdersTable = $('#closedTable').DataTable({
            paging: true,
            pageLength: 10,
            searching: true,
            info: true,
            responsive: true,
            order: [[7, "desc"]],
            language: { emptyTable: 'No closed trades found for the selected filters.' }
        });
        
        if ($('#leaderboardTable').length) {
            leaderboardTable = $('#leaderboardTable').DataTable({
                paging: false, searching: false, info: false, order: [[2, 'desc']]
            });
            $.get('/api/admin/performance_leaderboard', function(data) {
                leaderboardTable.clear();
                data.forEach((user, index) => {
                    leaderboardTable.row.add([
                        index + 1, user.username, colorPL(user.total_pl),
                        user.win_rate.toFixed(1) + '%', user.wins, user.losses, user.total_trades
                    ]);
                });
                leaderboardTable.draw();
            });
        }
        
        fetchAndRenderTrades();

        $('#dateFrom, #dateTo, #userFilter').on('change', fetchAndRenderTrades);
        
        $('[data-preset]').on('click', function() {
            const preset = $(this).data('preset'), now = luxon.DateTime.now();
            let start;
            if (preset === 'today') start = now.startOf('day');
            else if (preset === 'week') start = now.startOf('week');
            else if (preset === 'month') start = now.startOf('month');
            else if (preset === 'year') start = now.startOf('year');
            $('#dateFrom').val(start.toISODate());
            $('#dateTo').val(now.toISODate());
            fetchAndRenderTrades();
        });

        $('#clearDate').on('click', function() {
            $('#dateFrom, #dateTo').val('');
            fetchAndRenderTrades();
        });
    });
</script>
<style>
.stat-item { padding: 0.35rem 0; font-size: 0.95rem; display: flex; justify-content: space-between; }
</style>
{% endblock %}
