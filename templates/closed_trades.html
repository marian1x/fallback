{% extends "base.html" %}
{% block title %}Closed Trades - TradingBot{% endblock %}
{% block content %}
<div class="container my-4 animate__animated animate__fadeIn">
    <div class="row mb-3">
        <div class="col-12 col-lg-4">
            <label>Date range: </label>
            <input type="date" id="dateFrom" class="form-control form-control-sm d-inline" style="width:auto;display:inline-block;">
            <input type="date" id="dateTo" class="form-control form-control-sm d-inline" style="width:auto;display:inline-block;">
            <button class="btn btn-sm btn-outline-primary" id="clearDate">Clear</button>
        </div>
    </div>
    <div class="row g-4">
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <i class="fa fa-check-circle me-2"></i>Closed Orders
                </div>
                <div class="card-body">
                    <table id="closedTable" class="table table-striped table-hover table-responsive-lg" style="width:100%;">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Open Price</th>
                                <th>Close Price</th>
                                <th>P/L</th>
                                <th>P/L %</th>
                                <th>Open Time</th>
                                <th>Close Time</th>
                                <th>Exit Reason</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white">
                    <i class="fa fa-chart-pie me-2"></i>Closed Trade Stats
                </div>
                <div class="card-body">
                    <div id="ctStatPL" class="mb-2">P/L: $0</div>
                    <div id="ctStatWins" class="mb-2">Wins: 0</div>
                    <div id="ctStatLosses" class="mb-2">Losses: 0</div>
                    <div id="ctStatWinrate" class="mb-2">Win Rate: 0%</div>
                    <canvas id="ctPieChart" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script>
    // Convert ISO string (in UTC) to Europe/Bucharest time
    function toRomaniaTime(isoString) {
        if (!isoString) return "-";
        let dt = luxon.DateTime.fromISO(isoString, {zone: "utc"});
        let local = dt.setZone("Europe/Bucharest");
        return local.toFormat("dd/MM/yyyy, HH:mm:ss");
    }

    let closedOrdersRaw = [];
    let closedOrdersTable;
    let dateFilterFrom = "", dateFilterTo = "";

    function colorPL(val) {
        if (val > 0) return '<span class="text-success fw-bold">'+val.toFixed(4)+'</span>';
        if (val < 0) return '<span class="text-danger fw-bold">'+val.toFixed(4)+'</span>';
        return '<span>'+val.toFixed(4)+'</span>';
    }
    function fetchClosedOrders() {
        $.get('/api/closed_orders', function(data){
            closedOrdersRaw = data;
            filterAndRenderClosed();
        });
    }
    function filterAndRenderClosed() {
        let filtered = closedOrdersRaw.filter(r => {
            let c = (!dateFilterFrom || !r.close_time || r.close_time.slice(0,10) >= dateFilterFrom) &&
                    (!dateFilterTo || !r.close_time || r.close_time.slice(0,10) <= dateFilterTo);
            return c;
        });
        closedOrdersTable.clear();
        filtered.forEach(r => {
            let badge = '';
            if (r.action) {
                badge = `<span class="badge bg-info badge-exit animate__animated animate__fadeIn">${r.action}</span>`;
            }
            closedOrdersTable.row.add([
                r.symbol,
                r.side ? r.side.toUpperCase() : '-',
                r.open_price ? r.open_price.toFixed(8) : '-',
                r.close_price ? r.close_price.toFixed(8) : '-',
                colorPL(r.profit_loss || 0),
                r.profit_loss_pct ? r.profit_loss_pct.toFixed(4)+'%' : '-',
                r.open_time ? toRomaniaTime(r.open_time) : '-',
                r.close_time ? toRomaniaTime(r.close_time) : '-',
                badge
            ]);
        });
        closedOrdersTable.draw();
        updateStatsCharts(filtered);
    }
    function updateStatsCharts(filtered) {
        let totalPL = 0, wins = 0, losses = 0;
        filtered.forEach(x => {
            let pl = x.profit_loss || 0;
            totalPL += pl;
            if (pl > 0) wins++; else if (pl < 0) losses++;
        });
        let winrate = wins + losses > 0 ? (100 * wins / (wins + losses)).toFixed(1) : "0";
        $("#ctStatPL").html(colorPL(totalPL));
        $("#ctStatWins").text("Wins: " + wins);
        $("#ctStatLosses").text("Losses: " + losses);
        $("#ctStatWinrate").text("Win Rate: " + winrate + "%");

        let reasonMap = {};
        filtered.forEach(x => { if (x.action) reasonMap[x.action] = (reasonMap[x.action]||0)+1; });
        let reasons = Object.keys(reasonMap);
        let counts = reasons.map(r => reasonMap[r]);
        if (!window.ctPieChart) {
            window.ctPieChart = new Chart(document.getElementById('ctPieChart'), {
                type: 'pie',
                data: { labels: reasons, datasets: [{data: counts}] },
                options: {responsive: true, plugins: {legend: {display: true, position: 'bottom'}}}
            });
        } else {
            window.ctPieChart.data.labels = reasons; window.ctPieChart.data.datasets[0].data = counts; window.ctPieChart.update();
        }
    }
    $(document).ready(function(){
        closedOrdersTable = $('#closedTable').DataTable({
            paging: true, pageLength: 10, lengthMenu: [5, 10, 20, 50],
            searching: true, info: false, responsive: true, order: [[7, "desc"]]
        });
        fetchClosedOrders();
        setInterval(fetchClosedOrders, 20000);
        function updateDateFilters() {
            dateFilterFrom = $('#dateFrom').val();
            dateFilterTo = $('#dateTo').val();
            filterAndRenderClosed();
        }
        $('#dateFrom').on('change', updateDateFilters);
        $('#dateTo').on('change', updateDateFilters);
        $('#clearDate').on('click', function() {
            $('#dateFrom').val(''); $('#dateTo').val('');
            dateFilterFrom = ""; dateFilterTo = "";
            filterAndRenderClosed();
        });
    });
</script>
{% endblock %}