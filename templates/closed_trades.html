{% extends "base.html" %}
{% block title %}{{ _('Closed Trades') }} - {{ _('TradingBot') }}{% endblock %}
{% block content %}
<div class="container-fluid my-4 animate__animated animate__fadeIn">
    <div class="row mb-3 align-items-end">
        <div class="col-md-6">
            <label for="dateFrom" class="form-label small">{{ _('Filter by Close Date') }}</label>
            <div>
                <input type="date" id="dateFrom" class="form-control form-control-sm d-inline" style="width:auto;">
                <span>-</span>
                <input type="date" id="dateTo" class="form-control form-control-sm d-inline" style="width:auto;">
                <button class="btn btn-sm btn-outline-secondary" id="clearDate">{{ _('Clear') }}</button>
            </div>
        </div>
    </div>
    <div class="row g-4">
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <i class="fa fa-check-circle me-2"></i>{{ _('Closed Orders') }}
                </div>
                <div class="card-body">
                    <table id="closedTable" class="table table-hover" style="width:100%;">
                        <thead>
                            <tr>
                                <th>{{ _('Symbol') }}</th>
                                <th>{{ _('Side') }}</th>
                                <th>{{ _('Open Price') }}</th>
                                <th>{{ _('Close Price') }}</th>
                                <th>{{ _('P/L') }}</th>
                                <th>{{ _('P/L %%') }}</th>
                                <th>{{ _('Open Time') }}</th>
                                <th>{{ _('Close Time') }}</th>
                                <th>{{ _('Exit Reason') }}</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm mb-3">
                <div class="card-header">
                    <i class="fa fa-chart-pie me-2"></i>{{ _('Closed Trade Stats') }}
                </div>
                <div class="card-body">
                    <div class="stat-item" id="ctStatPL">{{ _('P/L') }}: $0</div>
                    <div class="stat-item" id="ctStatWins">{{ _('Wins') }}: 0</div>
                    <div class="stat-item" id="ctStatLosses">{{ _('Losses') }}: 0</div>
                    <div class="stat-item" id="ctStatWinrate">{{ _('Win Rate') }}: 0%</div>
                    <canvas id="ctPieChart" height="120" class="mt-3"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script>
    let allClosedOrders = [];
    let closedOrdersTable;

    function toLocalTime(isoString) {
        if (!isoString) return "-";
        return luxon.DateTime.fromISO(isoString, {zone: "utc"}).toFormat("dd/MM/yyyy, HH:mm:ss");
    }

    function colorPL(val) {
        if (val > 0) return `<span class="profit">+${val.toFixed(4)}</span>`;
        if (val < 0) return `<span class="loss">${val.toFixed(4)}</span>`;
        return `<span>${val.toFixed(4)}</span>`;
    }

    function fetchClosedOrders() {
        $.get('/api/closed_orders', function(data){
            allClosedOrders = data;
            renderFilteredTrades();
        });
    }

    function renderFilteredTrades() {
        const dateFrom = $('#dateFrom').val();
        const dateTo = $('#dateTo').val();

        let filtered = allClosedOrders.filter(r => {
            if (!r.close_time) return false;
            const closeDate = r.close_time.slice(0, 10);
            const fromOk = !dateFrom || closeDate >= dateFrom;
            const toOk = !dateTo || closeDate <= dateTo;
            return fromOk && toOk;
        });
        
        closedOrdersTable.clear();
        filtered.forEach(r => {
            let badge = '';
            if (r.action) {
                badge = `<span class="badge bg-info text-dark">${r.action}</span>`;
            }
            closedOrdersTable.row.add([
                r.symbol.replace('USD', '/USD'),
                r.side ? r.side.toUpperCase() : '-',
                r.open_price ? r.open_price.toFixed(8) : '-',
                r.close_price ? r.close_price.toFixed(8) : '-',
                colorPL(r.profit_loss || 0),
                r.profit_loss_pct ? r.profit_loss_pct.toFixed(4)+'%' : '-',
                {
                    _: r.open_time, // Raw data for sorting
                    display: toLocalTime(r.open_time) // Formatted data for display
                },
                {
                    _: r.close_time, // Raw data for sorting
                    display: toLocalTime(r.close_time) // Formatted data for display
                },
                badge
            ]);
        });
        closedOrdersTable.draw();
        updateStatsCharts(filtered);
    }

    function updateStatsCharts(filtered) {
        let totalPL = 0, wins = 0, losses = 0;
        filtered.forEach(x => {
            let pl = x.profit_loss || 0;
            totalPL += pl;
            if (pl > 0) wins++; else if (pl < 0) losses++;
        });
        let winrate = wins + losses > 0 ? (100 * wins / (wins + losses)).toFixed(1) : "0";
        $("#ctStatPL").html(`{{ _('P/L') }}: <span class="${totalPL >= 0 ? 'profit' : 'loss'}">$${totalPL.toFixed(2)}</span>`);
        $("#ctStatWins").text(`{{ _('Wins') }}: ${wins}`);
        $("#ctStatLosses").text(`{{ _('Losses') }}: ${losses}`);
        $("#ctStatWinrate").text(`{{ _('Win Rate') }}: ${winrate}%`);

        let reasonMap = {};
        filtered.forEach(x => { if (x.action) reasonMap[x.action] = (reasonMap[x.action]||0)+1; });
        let reasons = Object.keys(reasonMap);
        let counts = reasons.map(r => reasonMap[r]);
        if (!window.ctPieChart) {
            window.ctPieChart = new Chart(document.getElementById('ctPieChart'), {
                type: 'pie',
                data: { labels: reasons, datasets: [{data: counts}] },
                options: {responsive: true, plugins: {legend: {display: true, position: 'bottom'}}}
            });
        } else {
            window.ctPieChart.data.labels = reasons; window.ctPieChart.data.datasets[0].data = counts; window.ctPieChart.update();
        }
    }

    $(document).ready(function(){
        closedOrdersTable = $('#closedTable').DataTable({
            paging: true, pageLength: 10, lengthMenu: [10, 25, 50, 100],
            searching: true, info: true, responsive: true, order: [[7, "desc"]],
            columnDefs: [
                {
                    targets: [6, 7], // Target both Open Time and Close Time columns
                    render: function (data, type, row) {
                        // For display, use the 'display' property. For anything else (sort, filter), use the raw '_' property.
                        return type === 'display' ? data.display : data._;
                    }
                }
            ]
        });
        
        fetchClosedOrders();
        setInterval(fetchClosedOrders, 30000);

        $('#dateFrom, #dateTo').on('change', renderFilteredTrades);
        $('#clearDate').on('click', function() {
            $('#dateFrom').val(''); $('#dateTo').val('');
            renderFilteredTrades();
        });
    });
</script>
<style>
.stat-item {
    padding: 0.25rem 0;
}
</style>
{% endblock %}